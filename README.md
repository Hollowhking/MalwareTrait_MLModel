# MALWARE GENETIC ANALYSIS

This project seeks to analyse traits pulled from binlex and determine traits that are indicitive of malware.
Trojan files are malware that disguise itself as legitimate software, these are often difficult to identify due to a majority of the code being legitimate. 
As such this project serves as a proof of concept for another tool to detect trojan viruses.
## What are blocks:
Traits of binary files are code broken up into code blocks,
The code blocks are single entry single exit sections of a file.
Example:
~~~
	if(x){statement;}
	else{statement;}
~~~

Any point in which the program branches can be determined to be a "block".
 ## What are traits:
A trait is a wildcarded code block of a binary file.
This program uses binlex to extract traits from various malware samples as well as benign files in service of determining what kind of code is more previlent among malicous software.

An example of these traits is: 
~~~
	raw bytes of code block:	
	48 89 5c 24 08 4c 89 4c 24 20 55 56 57 41 54 51 55 41 56 41 57 48
	83 ec 20 45 8b d0 48 8b e9 0f b6 89 1f 0a 00 00 49 8b d9 41 d1 ea 
	41 f6 c0 01 75 07 41 8b c2 d3 e8 eb 06 41 8d 42 01 d3 e0 41 8d 3c 
	02 48 8b 82 88 00 00 00 c1 ef 09 08 7a 70 03 48 89 44 24 68 74 14 
	48 8b 85 a8 0a 00 00 8b cf 48 0f a3 08 72 05 45 32 ed eb 03 41 b5 
	01 8b f7 44 8d 67 01 c1 e6 09 45 33 ff 44 8b f6 49 c1 e4 09 4d 3b 
	f4 0f 83 e9 00 00 00 44 8b 85 18 0a 00 00 33 d2 8b c6 41 8d 48 01 
	f7 f1 41 3b d0 74 0b 44 8b de 45 2b d9 45 03 db eb 08 47 8d 1c 09 
	41 83 cb 01 45 8b c3 41 d1 e8 41 f6 c3 01 0f 85 94 00 00 00 44 3b
	85 3c 0a 00 00 0f 83 95 00 00 00 33 d2 48 8b cd e8 30 df ff ff 48 
	8b d8 83 e0 07 48 a9 fd ff ff ff 75 6f 48 81 fb 00 00 10 00 72 66 
	48 85 c0 75 0a 48 83 e3 f9 48 83 cb 01 eb 0e 48 83 f8 02 75 08 48 
	83 e3 fb 48 83 cb 03 4c 8b c3 41 8b d3 48 8b cd e8 7a df ff ff 45 
	85 ff 75 16 45 84 ed 74 11 4c 8b 44 24 68 8b d7 48 8b cd e8 fd e4 
	ff ff eb 1d 4c 8b c3 b2 01 48 8b cd e8 56 e4 ff ff 48 8b 4c 24 68 
	41 81 e6 ff 01 00 00 4a 89 04 f1 41 ff c7 ff c6 44 8b f6 4d 3b f4 
	0f 82 1c ff ff ff 48 8b 5c 24 78 48 8b 84 24 80 00 00 00 89 3b 48 
	8b 5c 24 60 44 89 38 48 83 c4 20 41 5f 41 5e 41 5d 41 5c 5f 5d c3

	Trait:
	48 89 5c 24 ?? 4c 89 4c 24 ?? 55 56 57 41 54 51 55 41 56 41 57 48 
	83 ec 20 45 8b d0 48 8b e9 0f b6 89 ?? ?? ?? ?? 49 8b d9 41 d1 ea 
	41 f6 c0 01 75 07 41 8b c2 d3 e8 eb 06 41 8d 42 ?? d3 e0 41 8d 3c 
	02 48 8b 82 ?? ?? ?? ?? c1 ef 09 08 7a ?? ?? 48 89 44 24 ?? 74 14 
	48 8b 85 ?? ?? ?? ?? 8b cf 48 0f a3 08 72 05 45 32 ed eb 03 41 b5 
	01 8b f7 44 8d 67 ?? c1 e6 09 45 33 ff 44 8b f6 49 c1 e4 09 4d 3b 
	f4 0f 83 e9 00 00 00 44 8b 85 ?? ?? ?? ?? 33 d2 8b c6 41 8d 48 ?? 
	f7 f1 41 3b d0 74 0b 44 8b de 45 2b d9 45 03 db eb 08 47 8d 1c 09 
	41 83 cb 01 45 8b c3 41 d1 e8 41 f6 c3 01 0f 85 94 00 00 00 44 3b 
	85 ?? ?? ?? ?? 0f 83 95 00 00 00 33 d2 48 8b cd e8 30 df ff ff 48 
	8b d8 83 e0 07 48 a9 fd ff ff ff 75 6f 48 81 fb 00 00 10 00 72 66 
	48 85 c0 75 0a 48 83 e3 f9 48 83 cb 01 eb 0e 48 83 f8 02 75 08 48 
	83 e3 fb 48 83 cb 03 4c 8b c3 41 8b d3 48 8b cd e8 7a df ff ff 45 
	85 ff 75 16 45 84 ed 74 11 4c 8b 44 24 ?? 8b d7 48 8b cd e8 fd e4 
	ff ff eb 1d 4c 8b c3 b2 01 48 8b cd e8 56 e4 ff ff 48 8b 4c 24 ?? 
	41 81 e6 ff 01 00 00 4a 89 04 f1 41 ff c7 ff c6 44 8b f6 4d 3b f4 
	0f 82 1c ff ff ff 48 8b 5c 24 ?? 48 8b 84 24 ?? ?? ?? ?? 89 3b 48 
	8b 5c 24 ?? 44 89 38 48 83 c4 20 41 5f 41 5e 41 5d 41 5c 5f 5d c3

Binary Assembled:
0:  48                      dec    eax
1:  89 5c 24 08             mov    DWORD PTR [esp+0x8],ebx
5:  4c                      dec    esp
6:  89 4c 24 20             mov    DWORD PTR [esp+0x20],ecx
a:  55                      push   ebp
b:  56                      push   esi
c:  57                      push   edi
d:  41                      inc    ecx
e:  54                      push   esp
f:  51                      push   ecx
10: 55                      push   ebp
11: 41                      inc    ecx
12: 56                      push   esi
13: 41                      inc    ecx
14: 57                      push   edi
15: 48                      dec    eax
16: 83 ec 20                sub    esp,0x20
19: 45                      inc    ebp
20: 8b d0                   mov    edx,eax
21: 48                      dec    eax
22: 8b e9                   mov    ebp,ecx
23: 0f b6 89 1f 0a 00 00    movzx  ecx,BYTE PTR [ecx+0xa1f]
24: ...
~~~
Binlex "wildcards" binary data. This process involves converting any memory operands or other operands that are subject to change into ??. This removes a lot of data that is device dependent, and leaves behind 
the data that is native to the file. 

# Analysis:

An analysis of 14,000 traits belonging to Agent Tesla samples, 22,000 traits belonging to begnign files, 6000 traits belonging to Loki samples:
The most common trait among malware samples is:
~~~
	'55 8b ec 8b 4d ?? 85 c9 75 04 33 c0 eb 25 
	8b 45 ?? 56 8b 75 ?? 99 3b ce 7d 0c f7 f9 
	85 d2 74 10 2b ca 8b d1 eb 0a f7 fe 85 d2 
	74 04 2b f2 8b d6 8b c2 5e 5d c2 0c 00'
~~~
	
This function performs a comparison and arithmetic operations involving division and subtraction. Storing the result into a variable before returning.
~~~
The most common trait exclusivly among malware samples is:
	'8b 55 ?? d9 5a ?? eb 30 8b 12 ff d2 8b 55 ?? dd 5a ?? 
	eb 24 8b 42 ?? 83 f8 04 74 12 8b 12 ff d2 8b 4d ?? 89 
	51 ?? 89 41 ?? 8b 55 ?? eb 0a 8b 12 ff d2 8b 55 ?? 89 
	42 ?? 39 65 ?? 74 0a b8 00 00 00 00 89 45 ?? eb 13 8b 
	4a ?? 83 f9 00 74 0b 8b 42 ?? 83 f8 01 75 03 03 62 ?? 
	61 8b 5d ?? 8b 45 ?? 8b e5 5d c2 04 00'
~~~
This function moves data within registers and memory, executes a function using the address stored within a variable. Then adjusts the stack and frame pointers in the prologue and epilogue of the function.

## The ML Model:
~~~
	Parameters:
		input_size = 3 
		hidden_size = 1500
		num_classes = 2  #binary classification
		num_epochs = 10
		batchsize = 64
		lr = 0.001
~~~
The neural network model attempts to find binary code snippets that are strong indecators that the file the trait belongs to is malware.
	![alt text](https://github.com/Hollowhking/MalwareTrait_MLModel/blob/master/Accuracy.png)
The accuracy achieved by the model plateaus at 80% however the data within the model is limited.


## Next Steps:
Expanding the dataset including more samples from different malware families as well as more benign traits.
	Creating a UI in which a file imported by a user could be stripped of its features by the Binlex system, and those traits run through the model and returning any traits that are common among malware. And
	Possibly a score stating how likely the file is or is not malware. As well a link to the most common malware family those traits belong to. 
